name: 'Get Current Build Count'
description: 'Get the current build count for a given pipeline ID'
inputs:
  pipeline-id: 
    description: 'The build definition ID to get the current build count for'
    required: true
  ado_token: 
    description: 'The Azure DevOps PAT token'
    required: true
  ado_url: 
    description: 'The Azure DevOps URL'
    required: true
outputs:
  current-build-count:
    description: 'The current build count for the specified pipeline'
    value: ${{ steps.get-current-build-count.outputs.CURRENT_BUILD_COUNT }}

runs:
  using: "composite"
  steps:
    - name: Get current build count
      id: get-current-build-count
      env:
        PIPELINE_ID: ${{ inputs.pipeline-id }}
        ADO_TOKEN: ${{ inputs.ado_token }}
        ADO_URL: ${{ inputs.ado_url }}
      shell: bash
      run: |
        echo "Getting current build count for pipeline ID $PIPELINE_ID"
        CURRENT_BUILD_COUNT=$(curl -s -H "Authorization: Basic $(echo -n ":$ADO_TOKEN}" | base64 -w0)" \
          "$ADO_URL/_apis/build/builds?api-version=6.0&definitions=$PIPELINE_ID&queryOrder=queueTimeDescending&\$top=1" | \
          jq '.value[0].id')
        echo "CURRENT_BUILD_COUNT=$CURRENT_BUILD_COUNT" >> $GITHUB_ENV
        echo "Current build count: $CURRENT_BUILD_COUNT"
